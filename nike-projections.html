<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BMS × Nike — Projections</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{--bg:#0f1a23;--card:#12212c;--text:#dfe7ee;--muted:#a7bac8;--brand:#1db954;--line:#243645}
  html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:42px auto;padding:0 16px}
  h1{margin:0 0 18px}
  .grid{display:grid;gap:18px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:18px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left}
  th{color:var(--muted);font-weight:600}
  textarea{width:100%;min-height:180px;background:#0a141b;border:1px solid var(--line);border-radius:10px;color:var(--text);padding:12px;font:14px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  button{background:var(--brand);border:0;border-radius:8px;color:#03200d;font-weight:700;padding:10px 14px;cursor:pointer}
  .muted{color:var(--muted)}
  /* PIN overlay */
  .gate{position:fixed;inset:0;background:rgba(15,26,35,.96);display:flex;align-items:center;justify-content:center;z-index:50}
  .panel{width:min(440px,90vw);background:#0e1921;border:1px solid #223544;border-radius:12px;padding:22px}
  .panel h2{margin:0 0 10px;font-size:20px}
  .rowpin{display:flex;gap:8px;margin-top:12px}
  input{flex:1;background:#0a141b;border:1px solid #243645;border-radius:8px;padding:10px;color:var(--text)}
  .err{color:#ffb3b3;font-size:13px;margin-top:8px;display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>Projections</h1>

  <div class="grid">
    <div class="row">
      <div class="card">
        <h3 style="margin:0 0 8px">Tons Processed by Month</h3>
        <canvas id="tons"></canvas>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px">Revenue by Month ($)</h3>
        <canvas id="rev"></canvas>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h3 style="margin:0 0 8px">CO₂e Avoided by Month (t)</h3>
        <canvas id="co2"></canvas>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px">Unit Economics</h3>
        <table>
          <tbody id="unitRows">
            <tr><th>Avg ASP per ton</th><td id="aspCell">$—/t</td></tr>
            <tr><th>Processing cost per ton</th><td id="costCell">$—/t</td></tr>
            <tr><th>Gross margin per ton</th><td id="gmCell">$—/t</td></tr>
            <tr><th>Payback period (months)</th><td id="pbCell">—</td></tr>
          </tbody>
        </table>
        <p class="muted" style="margin:8px 0 0">Assumes linear ramp; adjustable in data.</p>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Assumptions (edit → Update)</h3>
      <p class="muted" style="margin:0 0 10px">Edit the JSON below and tap <b>Update</b> to refresh charts and calculations.</p>
      <textarea id="jsonBox">{
  "months": 24,
  "startMonth": "Oct 2025",
  "rampToMonthly": 40,
  "rampMonthlyAdd": 10,
  "aspPerTon": 280,
  "costPerTon": 140,
  "fixedMonthly": 18000,
  "co2PerTon": 1.6,
  "capex": 150000
}</textarea>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="updateBtn">Update</button>
        <span id="errMsg" class="muted"></span>
      </div>
    </div>
  </div>

  <p style="margin-top:16px"><a class="muted" href="index.html">← Back to Dashboard</a></p>
</div>

<!-- PIN gate -->
<div class="gate" id="gate">
  <div class="panel">
    <h2>Enter PIN</h2>
    <p class="muted" style="margin:0 0 8px">This page is restricted.</p>
    <div class="rowpin">
      <input id="pin" inputmode="numeric" placeholder="PIN" />
      <button id="go">Unlock</button>
    </div>
    <div id="bad" class="err">Incorrect PIN. Try again.</div>
  </div>
</div>

<script>
  // ---------- PIN (same as portal) ----------
  const REQUIRED_PIN = "2468";
  function isAuthed(){ try { return localStorage.getItem("bmsPin") === REQUIRED_PIN } catch(e){ return false } }
  function lock(){ document.getElementById("gate").style.display = "flex"; }
  function unlock(){ document.getElementById("gate").style.display = "none"; }
  if(isAuthed()) unlock();
  document.getElementById("go").onclick = () => {
    const v = document.getElementById("pin").value.trim();
    if(v === REQUIRED_PIN){ try{ localStorage.setItem("bmsPin", v) }catch(e){}; unlock(); }
    else { document.getElementById("bad").style.display = "block"; }
  };

  // ---------- Charts + calculations ----------
  const tonsCtx = document.getElementById('tons');
  const revCtx  = document.getElementById('rev');
  const co2Ctx  = document.getElementById('co2');

  let tonsChart, revChart, co2Chart;

  function calcSeries(cfg){
    const m = cfg.months|0;
    const labels = Array.from({length:m},(_,i)=>`M${i+1}`);
    const tons = [];
    // Simple linear ramp to target, then flat
    for(let i=0;i<m;i++){
      const t = Math.min(cfg.rampToMonthly, cfg.rampMonthlyAdd*(i+1));
      tons.push(t);
    }
    const revenue = tons.map(t=>t*cfg.aspPerTon);
    const marginPerTon = cfg.aspPerTon - cfg.costPerTon;
    const margin = tons.map((t,i)=> t*marginPerTon - cfg.fixedMonthly);
    // Payback: cumulative margin vs capex
    let cum = 0, pb = m;
    for(let i=0;i<m;i++){ cum += margin[i]; if(cum>=cfg.capex){ pb = i+1; break; } }
    const co2 = tons.map(t=> t*cfg.co2PerTon);
    return {labels, tons, revenue, co2, pb, marginPerTon};
  }

  function draw(cfg){
    const s = calcSeries(cfg);

    // Unit econ table
    document.getElementById('aspCell').textContent  = `$${cfg.aspPerTon}/t`;
    document.getElementById('costCell').textContent = `$${cfg.costPerTon}/t`;
    document.getElementById('gmCell').textContent   = `$${s.marginPerTon}/t`;
    document.getElementById('pbCell').textContent   = s.pb;

    const opts = {responsive:true, maintainAspectRatio:false, scales:{x:{ticks:{color:"#9fb3c3"}}, y:{ticks:{color:"#9fb3c3"}, grid:{color:"#1e3240"}}}, plugins:{legend:{display:false}}};

    if(tonsChart) tonsChart.destroy();
    if(revChart) revChart.destroy();
    if(co2Chart) co2Chart.destroy();

    tonsChart = new Chart(tonsCtx, {type:'line', data:{labels:s.labels, datasets:[{data:s.tons} ]}, options:opts});
    revChart  = new Chart(revCtx,  {type:'line', data:{labels:s.labels, datasets:[{data:s.revenue}]}, options:opts});
    co2Chart  = new Chart(co2Ctx,  {type:'line', data:{labels:s.labels, datasets:[{data:s.co2}]}, options:opts});
  }

  function parseJSON(){
    const raw = document.getElementById('jsonBox').value;
    try{
      const cfg = JSON.parse(raw);
      // Basic sanity defaults
      return Object.assign({
        months:24, rampToMonthly:40, rampMonthlyAdd:10, aspPerTon:280, costPerTon:140, fixedMonthly:18000, co2PerTon:1.6, capex:150000
      }, cfg);
    }catch(e){
      document.getElementById('errMsg').textContent = "Invalid JSON – please fix format.";
      throw e;
    }
  }

  document.getElementById('updateBtn').onclick = ()=>{
    document.getElementById('errMsg').textContent = "";
    try{ draw(parseJSON()); }catch(e){}
  };

  // Initial render
  draw(parseJSON());
</script>
</body>
</html>
